name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
          
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'venv' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.DS_Store' \
            --exclude 'database/*.db' \
            --exclude 'database/*.sqlite' \
            --exclude '.env' \
            ./ $SERVER_USER@$SERVER_HOST:/opt/freighthub/
          
          # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh $SERVER_USER@$SERVER_HOST "echo 'BOT_TOKEN=$BOT_TOKEN' > /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'WEBAPP_URL=http://$SERVER_HOST' >> /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'TELEGRAM_BOT_WEBHOOK_URL=http://telegram-bot:8080' >> /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'WEBHOOK_SECRET=$WEBHOOK_SECRET' >> /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'DATABASE_PATH=/app/database/delivery.db' >> /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'SERVER_HOST=$SERVER_HOST' >> /opt/freighthub/.env"
          ssh $SERVER_USER@$SERVER_HOST "echo 'WEBHOOK_PORT=8080' >> /opt/freighthub/.env"
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          ssh $SERVER_USER@$SERVER_HOST "cd /opt/freighthub && docker-compose down"
          ssh $SERVER_USER@$SERVER_HOST "cd /opt/freighthub && docker-compose build --no-cache"
          ssh $SERVER_USER@$SERVER_HOST "cd /opt/freighthub && docker-compose up -d"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
          sleep 5
          ssh $SERVER_USER@$SERVER_HOST "cd /opt/freighthub && docker-compose ps"
          
          echo "üìã –õ–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞:"
          ssh $SERVER_USER@$SERVER_HOST "cd /opt/freighthub && docker-compose logs --tail=50"
          
          echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
